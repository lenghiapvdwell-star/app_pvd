import streamlit as st
import pandas as pd
import gspread
from google.oauth2.service_account import Credentials
import binascii

# 1. C·∫•u h√¨nh trang
st.set_page_config(page_title="PVD Personnel 2026", layout="wide")

# 2. M√É KH√ìA D·∫†NG HEX (ƒê√£ lo·∫°i b·ªè ho√†n to√†n c√°c k√Ω t·ª± g√¢y l·ªói PEM)
HEX_KEY = (
    "2d2d2d2d2d424547494e2050524956415445204b45592d2d2d2d2d0a4d494945765149424144414e42676b71686b6947397730424151454641415343424b63776767536a41674541416f49424151444871377149795363464c31326a0a3253386475412b4d70786f6b63396670756c4c66486d55644f4942755a6332324d6c67726c322f526c6a78312b743941427442535261736b6e6663793854546c0a7859646e366d49774942727a30306a6f75674476724462435274552b6b55505464495169324377667a484f306b64566c444e6a58484f66617130594e724363660a32663355623451372f59704e4e4d6e704364362b34356e4f6b475a5134677a2b4c48333666544752396f54666d4f6e495a346f30737448794f304970776831680a76394b4c51416f4d426d4c6a386837554158464c4c627a424639794158737a4333436b36313141374b37334e445a46546c4543674853624451536475504855510a4c38384d515735434d4b4a2f705739634375774448564152546f324742626b4231646c4441735a4152572f366431354f6963614e455a2b796f5173437a564c0a78742b72366f417a41674d4241414543676745414a3069304e49464f2b676774706a54757669776563772f565a754b62306c4a6b52353256533042346c442f580a543064736268636e2b745a53497577767a45774b354954736652484f4e75695a2f624c315277366f4c7376434b4a4f765070614a354a322f55453362577044500a425756684d664853444a65504644473143474b5572773379312b546d72583333584a376f2f386a492f58794f6e30344a593533376778634968636d484e395a490a744f5844612b65596531794a3545414e4b46566e642f334754527769723077375a764234426136634c3448643264584d2f787636396a6b4d774b2f6e623771620a6e65744631746d6c5578546a6e454648416b6c305a497a43564e79344b5567343479446d7158795451736c4e48784b644864586961304d52347654306c75534f0a4666744c794f3739376f6d2b7175574d6a3469374c6b734b56553945596d6c484e395a444747467867514b426751446f5552446a3270466937384b706b3969340a48394e764172352f6c6f32726c477641627435357164724847627665776a4c4944385746525267524c6632526e694f545a52747a724e465465334149576c6a760a6c4537687849706e52576a596f4d4c6b4c624f58334a6961685a796b3759326430522b306e6d4a4d4d69714974496d733754536b4669686f4e7248476c0a50355639675339506d627937644a4151446b3070524b63346f514b426751446342713439496c7a6a6c4b524a4d577a626d6b2f6b4962424639655755584a690a4473772b4d594f34635059363658492f396362386e56655444725678712f5742576b4b3539366875544f365a364533686a364463464463676957754c6a7a43720a536241494f35314e485139614536653268745873735a76743264536f514e6d7a6c324551484b523752394b776d73712b6b3875614b3668346e586578515755640a57784a3139796b55774b426747564d33414750442f4246506575313154314d5732532f6e4a4f44385a694d716f4f4a6c4b63576770686f787a7632454443650a642f474a31466e425a523033434b6f2f337a324d634f5a6e483833306e323078504c6f3552706b7772767644672b5a5630623949445770784253444b4436474e0a4e6c4764386e5a50506d4f52664e4b57396e4b356f564d315179585a3075424d6e6f4851622f48557872417976704c527561477946767968416f4741473045670a6d4359483546454147554537506269616f6e5a78536b36645145647664315759336a5372696766392f363750314f3172447431493436344566437333440a46565965495075616d716e7836377a553269344f33684c6e705850395077353152612f4d766c365a4a6d6c464478454973726355384c754934676157634f36520a63574e3635474a7a4d4c6b62344275436e7768466942744a56575a5a6474647642723356774530436759454135396b5357475571726f4a72743648446d5458490a627a6868744d5a723346654b39536e78784336566443676c4f4e54504d41526b693930746246624b347358796a476e7247664f6f6c4d43562b64316a666b5457560a362f694d38496853454e4537573655367354354441684a6837705a53487435454a395678335a674a57546f45336c657953444d50794f2b5138352f656e796f0a494135646c46567633715155547450463965524555633d0a2d2d2d2d2d454e442050524956415445204b45592d2d2d2d2d0a"
)

# 3. K·∫øt n·ªëi
@st.cache_resource
def get_gsheet_client():
    # Gi·∫£i m√£ Hex v·ªÅ d·∫°ng PEM thu·∫ßn t√∫y
    pem_data = binascii.unhexlify(HEX_KEY).decode("utf-8")
    
    cred_info = {
        "type": "service_account",
        "project_id": "pvd-management-87",
        "private_key_id": "ef315ddc41c52034e6f3897694a8af63de3c0fdd",
        "private_key": pem_data,
        "client_email": "pvd-sync@pvd-management-87.iam.gserviceaccount.com",
        "token_uri": "https://oauth2.googleapis.com/token",
    }
    
    scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    creds = Credentials.from_service_account_info(cred_info, scopes=scopes)
    return gspread.authorize(creds)

st.title("üö¢ PVD PERSONNEL CLOUD 2026")

try:
    client = get_gsheet_client()
    # M·ªü b·∫±ng ID b·∫£ng t√≠nh
    sheet = client.open_by_key("1mNVM-Gq6JkF41Yz7JDRiiLtWOtoQHnXwyp3LTRGt-2E")
    worksheet = sheet.worksheet("PVD_Data")
    
    # Hi·ªÉn th·ªã d·ªØ li·ªáu
    df = pd.DataFrame(worksheet.get_all_records())
    st.success("‚úÖ K·∫æT N·ªêI CLOUD TH√ÄNH C√îNG!")
    st.dataframe(df, use_container_width=True)

except Exception as e:
    st.error(f"‚ùå L·ªñI: {e}")
    st.info("H√£y ƒë·∫£m b·∫£o Tab trong Google Sheet t√™n l√† 'PVD_Data'.")
